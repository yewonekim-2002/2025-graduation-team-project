<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í™ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #F7F9FC;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    /* ì‚¬ìš©ì ë©”ë‰´ ë“œë¡­ë‹¤ìš´ */
    .user-menu { position: relative; display: inline-block; }
    .user-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      transform: translateY(-8px);
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 8px;
      min-width: 160px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .user-dropdown a {
      display: block;
      padding: 8px 12px;
      font-size: 14px;
      color: #333;
      text-decoration: none;
    }
    .user-dropdown a:hover {
      background-color: #f0f0f0;
    }
    .user-menu:hover .user-dropdown { display: block; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <header class="bg-white shadow-md py-4">
    <nav class="container flex justify-between items-center">
      <div class="flex items-center space-x-6">
        <a href="home.html" class="text-blue-600 text-lg font-bold">í™ˆ</a>
        <a href="word_main.html" class="text-gray-800 text-lg font-bold">ë‹¨ì–´ì¥</a>
        <a href="word_tool_main.html" class="text-gray-800 text-lg font-bold">í•™ìŠµ ë„êµ¬</a>
        <a href="word_dashboard.html" class="text-gray-800 text-lg font-bold">ì‚¬ìš©ì</a>
      </div>
      <div id="authContainer" class="flex items-center space-x-4"></div>
    </nav>
  </header>

  <main class="container">
    <!-- ë©”ì¸ íƒ€ì´í‹€ ë° ê²€ìƒ‰ ì„¹ì…˜ -->
    <section class="text-center my-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">
        ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•˜ê³ <br>ë‚˜ë§Œì˜ ë‹¨ì–´ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”
      </h1>
      <p class="text-lg text-gray-500 mb-8">
        ê²€ìƒ‰ë§Œ í•´ë„ ìë™ìœ¼ë¡œ ë‹¨ì–´ì¥ì´ ìƒì„±ë©ë‹ˆë‹¤
      </p>
      <div class="relative max-w-2xl mx-auto">
        <input id="searchInput" type="text" 
          placeholder="ë‹¨ì–´ë¥¼ ê²€ìƒ‰í•˜ê³  ë‚˜ë§Œì˜ ë‹¨ì–´ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”"
          class="w-full px-6 py-4 rounded-full border border-gray-300
                 focus:outline-none focus:ring-2 focus:ring-blue-500
                 transition shadow-lg">
        <button id="searchBtn"
          class="absolute right-0 top-0 mt-4 mr-6 text-gray-400 hover:text-blue-600 transition">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </section>

    <!-- í•™ìŠµ í˜„í™© ëŒ€ì‹œë³´ë“œ -->
    <section class="bg-white p-6 rounded-xl shadow-lg mt-12">
      <h2 class="text-2xl font-bold mb-6">ë‚˜ì˜ í•™ìŠµ í˜„í™©</h2>

      <div class="flex flex-col sm:flex-row justify-between items-center 
                  space-y-4 sm:space-y-0 sm:space-x-4">

        <!-- ì´ í•™ìŠµ ë‹¨ì–´ -->
        <div class="p-6 rounded-lg bg-blue-50 flex-1">
          <h3 class="text-base font-semibold text-gray-800 mb-2">ì´ í•™ìŠµ ë‹¨ì–´</h3>
          <p id="stat_totalWords" class="text-4xl font-bold text-blue-600 mb-2">0ê°œ</p>
          <p class="text-xs text-gray-500">ì§€ê¸ˆê¹Œì§€ í•™ìŠµí•œ ë‹¨ì–´ ìˆ˜ì…ë‹ˆë‹¤.</p>
        </div>

        <!-- í€´ì¦ˆ ì°¸ì—¬ íšŸìˆ˜ -->
        <div class="p-6 rounded-lg bg-green-50 flex-1">
          <h3 class="text-base font-semibold text-gray-800 mb-2">í€´ì¦ˆ ì°¸ì—¬ íšŸìˆ˜</h3>
          <p id="stat_quizCount" class="text-4xl font-bold text-green-600 mb-2">0íšŒ</p>
          <p class="text-xs text-gray-500">í•™ìŠµ ë„êµ¬ ì°¸ì—¬ ê¸°ë¡ì…ë‹ˆë‹¤.</p>
        </div>

        <!-- ì–´ì œ í•™ìŠµ ë‹¨ì–´ -->
        <div class="p-6 rounded-lg bg-yellow-50 flex-1">
          <h3 class="text-base font-semibold text-gray-800 mb-2">ì–´ì œ í•™ìŠµ ë‹¨ì–´</h3>
          <p id="stat_yesterdayWords" class="text-4xl font-bold text-yellow-600 mb-2">0ê°œ</p>
          <p class="text-xs text-gray-500">ì–´ì œ í•™ìŠµí•œ ë‹¨ì–´ ìˆ˜ì…ë‹ˆë‹¤.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase Auth + Firestore + ê²€ìƒ‰ ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

    import {
      getFirestore, doc, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    /* Firebase ì´ˆê¸°í™” */
    const firebaseConfig = {
      apiKey: "AIzaSyBXc7qF3lz2dbWOu1O3ftSNu8dye1RLk3E",
      authDomain: "auto-dictionary-29936.firebaseapp.com",
      projectId: "auto-dictionary-29936",
      storageBucket: "auto-dictionary-29936.appspot.com",
      messagingSenderId: "103494421267",
      appId: "1:103494421267:web:6762683fac5ac130e468e6",
      measurementId: "G-EKSJXHHRYS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();
    const db = getFirestore();
    const authContainer = document.getElementById("authContainer");

    /* ë¡œê·¸ì¸ UI ì—…ë°ì´íŠ¸ */
    function login() { signInWithPopup(auth, provider); }
    function logout() { signOut(auth); }

    function updateAuthUI(user) {
      authContainer.innerHTML = '';
      if (user) {
        const name = user.displayName
          ? (user.displayName.length > 5 ? user.displayName.slice(0,5)+'â€¦' : user.displayName)
          : (user.email || 'ì‚¬ìš©ì');

        authContainer.innerHTML = `
          <div class="user-menu">
            <a href="#" class="flex items-center space-x-2" style="text-decoration:none; min-width:120px;">
              <span class="user-label font-semibold">${name}</span>
              <img src="${user.photoURL || ''}" 
                   style="width:28px;height:28px;border-radius:50%;" />
            </a>
            <div class="user-dropdown">
              <a href="#">${user.email}</a>
              <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
          </div>`;
        document.getElementById('logoutBtn')?.addEventListener('click', logout);
      } else {
        authContainer.innerHTML =
          `<button id="loginBtn" class="px-4 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold">ë¡œê·¸ì¸</button>`;
        document.getElementById('loginBtn')?.addEventListener('click', login);
      }
    }

    /* ğŸŸ¦ í•™ìŠµ í˜„í™© Firestore ì—°ë™ í•¨ìˆ˜ */
    async function loadLearningStats(user) {
      const userRef = doc(db, "users", user.email);

      // --- ì´ í•™ìŠµ ë‹¨ì–´ ---
      let totalWords = 0;
      const datesCol = collection(userRef, "dates");
      const datesSnap = await getDocs(datesCol);

      for (const d of datesSnap.docs) {
        const shCol = collection(d.ref, "searchHistory");
        const shSnap = await getDocs(shCol);
        totalWords += shSnap.size;
      }
      document.getElementById("stat_totalWords").innerText = `${totalWords}ê°œ`;

      // --- í€´ì¦ˆ ì°¸ì—¬(í•™ìŠµ ë„êµ¬) íšŸìˆ˜ ---
      const toolsCol = collection(userRef, "tool");
      const toolsSnap = await getDocs(toolsCol);
      const quizCount = toolsSnap.size;
      document.getElementById("stat_quizCount").innerText = `${quizCount}íšŒ`;

      // --- ì–´ì œ í•™ìŠµ ë‹¨ì–´ ---
      const today = new Date();
      today.setDate(today.getDate() - 1);

      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      const yesterdayId = `${y}-${m}-${d}`;

      const yesterdayRef = doc(userRef, "dates", yesterdayId);
      const yesterdayShCol = collection(yesterdayRef, "searchHistory");
      const yesterdaySnap = await getDocs(yesterdayShCol);

      document.getElementById("stat_yesterdayWords").innerText =
        `${yesterdaySnap.size}ê°œ`;
    }

    /* ë¡œê·¸ì¸ ê°ì§€ - ë°ì´í„° ë¡œë“œ */
    onAuthStateChanged(auth, async (user) => {
      updateAuthUI(user);

      if (user) {
        await loadLearningStats(user);   /* ğŸ”¥ ì—¬ê¸°ì„œ í•™ìŠµ ë°ì´í„° ë¡œë“œ */
      }
    });

    /* ê²€ìƒ‰ ê¸°ëŠ¥ */
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");

    function searchWord() {
      const query = searchInput.value.trim();
      if (query) {
        window.location.href = `word_search_result.html?word=${encodeURIComponent(query)}`;
      } else {
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
      }
    }

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchWord();
    });
    searchBtn.addEventListener("click", searchWord);

  </script>
</body>
</html>
