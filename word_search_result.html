<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê²€ìƒ‰ ê²°ê³¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: #F7F9FC;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .user-menu {
      position: relative;
      display: inline-block;
    }

    .user-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      transform: translateY(-8px);
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 8px;
      min-width: 160px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, .1);
      z-index: 100;
    }

    .user-dropdown a {
      display: block;
      padding: 8px 12px;
      font-size: 14px;
      color: #333;
      text-decoration: none;
    }

    .user-dropdown a:hover {
      background: #f0f0f0;
    }

    .user-menu:hover .user-dropdown {
      display: block;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
  <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
  <header class="bg-white shadow-md py-4">
    <nav class="container flex justify-between items-center">
      <div class="flex items-center space-x-6">
        <a href="home.html" class="text-blue-600 text-lg font-bold">í™ˆ</a>
        <a href="word_main.html" class="text-gray-800 text-lg font-bold">ë‹¨ì–´ì¥</a>
        <a href="word_tool_main.html" class="text-gray-800 text-lg font-bold">í•™ìŠµ ë„êµ¬</a>
        <a href="word_dashboard.html" class="text-gray-800 text-lg font-bold">ì‚¬ìš©ì</a>
      </div>
      <div id="authContainer" class="flex items-center space-x-4"></div>
    </nav>
  </header>

  <main class="container">
    <!-- ê²€ìƒ‰ì°½ -->
    <section class="flex flex-col sm:flex-row justify-center items-center my-8">
      <div class="relative w-full sm:w-1/2">
        <input id="searchInput" type="text" placeholder="ë‹¨ì–´ ê²€ìƒ‰"
          class="w-full px-6 py-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition shadow-lg">
        <button id="searchBtn" class="absolute right-0 top-0 mt-4 mr-6 text-gray-400 hover:text-blue-600 transition">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </section>

    <!-- ê²°ê³¼ ì¹´ë“œ -->
    <div class="bg-white p-6 rounded-xl shadow-lg mt-8">
      <h2 id="wordTitle" class="text-3xl font-bold mb-4">ê²€ìƒ‰ì–´</h2>

      <!-- ë””ë²„ê·¸/ì•Œë¦¼ -->
      <pre id="resultBox" class="text-sm text-gray-500 whitespace-pre-wrap mb-4" style="display:none;"></pre>

      <div class="space-y-4">
        <div class="flex items-start space-x-2">
          <h3 class="font-semibold text-gray-700 flex-shrink-0">ëœ»:</h3>
          <p id="meaning" class="text-gray-900">-</p>
        </div>
        <div class="flex items-start space-x-2">
          <h3 class="font-semibold text-gray-700 flex-shrink-0">ìœ ì˜ì–´:</h3>
          <p id="synonyms" class="text-gray-900">-</p>
        </div>
        <div class="flex items-start space-x-2">
          <h3 class="font-semibold text-gray-700 flex-shrink-0">ë°˜ì˜ì–´:</h3>
          <p id="antonyms" class="text-gray-900">-</p>
        </div>
        <div class="flex items-start space-x-2">
          <h3 class="font-semibold text-gray-700 flex-shrink-0">ì˜ˆë¬¸:</h3>
          <p id="example" class="text-gray-900">-</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase + Firestore (Public Repo Safe Version) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    // âœ… ê³µê°œ ì €ì¥ì†Œ(í¬íŠ¸í´ë¦¬ì˜¤) ë²„ì „: ì™¸ë¶€ API(OpenAI ë“±) í˜¸ì¶œ ë¹„í™œì„±í™”
    const PUBLIC_REPO_MODE = true;

    // --- Firebase ì´ˆê¸°í™” ---
    const firebaseConfig = {
      apiKey: "AIzaSyBXc7qF3lz2dbWOu1O3ftSNu8dye1RLk3E",
      authDomain: "auto-dictionary-29936.firebaseapp.com",
      projectId: "auto-dictionary-29936",
      storageBucket: "auto-dictionary-29936.appspot.com",
      messagingSenderId: "103494421267",
      appId: "1:103494421267:web:6762683fac5ac130e468e6",
      measurementId: "G-EKSJXHHRYS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const provider = new GoogleAuthProvider();

    // --- ì—˜ë¦¬ë¨¼íŠ¸ ---
    const authContainer = document.getElementById("authContainer");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const wordTitle = document.getElementById("wordTitle");
    const meaningEl = document.getElementById("meaning");
    const synonymsEl = document.getElementById("synonyms");
    const antonymsEl = document.getElementById("antonyms");
    const exampleEl = document.getElementById("example");
    const resultBox = document.getElementById("resultBox");

    const rowOf = (el) => el?.parentElement;

    const cleanList = (arr, max = 5) =>
      [...new Set((arr || []).map(x => String(x).trim()).filter(Boolean))].slice(0, max);

    function renderField(el, listOrText) {
      if (!el) return;
      let has = false;

      if (Array.isArray(listOrText)) {
        const list = cleanList(listOrText, 999);
        if (list.length) { el.textContent = list.join(", "); has = true; }
      } else if (typeof listOrText === "string" && listOrText.trim()) {
        el.textContent = listOrText.trim(); has = true;
      }

      const row = rowOf(el);
      if (row) row.style.display = has ? "" : "none";
    }

    function login() { signInWithPopup(auth, provider); }
    function logout() { signOut(auth); }

    function updateAuthUI(user) {
      authContainer.innerHTML = '';
      if (user) {
        const name = user.displayName
          ? (user.displayName.length > 5 ? user.displayName.slice(0, 5) + 'â€¦' : user.displayName)
          : (user.email || 'ì‚¬ìš©ì');

        authContainer.innerHTML = `
          <div class="user-menu">
            <a href="javascript:void(0);" class="flex items-center space-x-2" style="min-width:120px;">
              <span class="user-label font-semibold">${name}</span>
              <img src="${user.photoURL || ''}" alt="ì‚¬ìš©ì" style="width:28px;height:28px;border-radius:50%;"/>
            </a>
            <div class="user-dropdown">
              <a href="#">${user.email}</a>
              <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
          </div>`;

        document.getElementById('logoutBtn')?.addEventListener('click', e => { e.preventDefault(); logout(); });
      } else {
        authContainer.innerHTML = `
          <button id="loginBtn"
            class="px-4 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 transition">
            ë¡œê·¸ì¸
          </button>`;
        document.getElementById('loginBtn')?.addEventListener('click', login);
      }
    }

    function searchWord() {
      const q = searchInput.value.trim();
      if (q) window.location.href = `word_search_result.html?word=${encodeURIComponent(q)}`;
      else alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
    }

    searchInput.addEventListener("keydown", e => { if (e.key === "Enter") searchWord(); });
    searchBtn.addEventListener("click", searchWord);

    onAuthStateChanged(auth, async (user) => {
      updateAuthUI(user);

      const params = new URLSearchParams(window.location.search);
      const word = params.get("word")?.toLowerCase() || "";

      if (!word) {
        wordTitle.textContent = "ê²€ìƒ‰ì–´ ì—†ìŒ";
        [meaningEl, synonymsEl, antonymsEl, exampleEl].forEach(el => rowOf(el).style.display = "none");
        resultBox.style.display = ""; resultBox.textContent = "ê²€ìƒ‰ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      if (!/^[a-zA-Z]+$/.test(word)) {
        wordTitle.textContent = word;
        [meaningEl, synonymsEl, antonymsEl, exampleEl].forEach(el => rowOf(el).style.display = "none");
        resultBox.style.display = ""; resultBox.textContent = "âš ï¸ ì˜ì–´ ë‹¨ì–´ë§Œ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        return;
      }

      wordTitle.textContent = word;
      resultBox.style.display = "none";

      let meaning = [], synonyms = [], antonyms = [], examples = [];

      try {
        const dictRef = doc(db, "dictionary", word);
        const dictSnap = await getDoc(dictRef);

        if (dictSnap.exists()) {
          const d = dictSnap.data();
          meaning = cleanList(d.korean_translations, 5);
          synonyms = cleanList(d.synonyms, 5);
          antonyms = cleanList(d.antonyms, 5);
          examples = cleanList(d.examples, 1);
        } else {
          // âœ… ê³µê°œ ì €ì¥ì†Œ ë²„ì „ì—ì„œëŠ” ì™¸ë¶€ API í˜¸ì¶œ(ì˜ˆ: OpenAI)ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          if (PUBLIC_REPO_MODE) {
            [meaningEl, synonymsEl, antonymsEl, exampleEl].forEach(el => rowOf(el).style.display = "none");
            resultBox.style.display = "";
            resultBox.textContent =
              "âš ï¸ ê³µê°œ ì €ì¥ì†Œ(í¬íŠ¸í´ë¦¬ì˜¤) ë²„ì „ì—ì„œëŠ” ì™¸ë¶€ API í˜¸ì¶œ(OpenAI ë“±)ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n" +
              "í˜„ì¬ëŠ” Firestoreì— ì €ì¥ëœ ë‹¨ì–´ë§Œ ê²°ê³¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.";
            return;
          }

          // (ë¡œì»¬/ë¹„ê³µê°œ í™˜ê²½ì—ì„œë§Œ) ì™¸ë¶€ API í˜¸ì¶œ ë¡œì§ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          // ğŸ”’ API í‚¤ëŠ” ì ˆëŒ€ í”„ë¡ íŠ¸ ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ë§ˆì„¸ìš”.
          resultBox.style.display = ""; resultBox.textContent = "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ";
          return;
        }

        const exampleText = (examples[0] || "")
          .replace(/^["â€œâ€]+|["â€œâ€]+$/g, "")
          .replace(/\s+/g, " ")
          .trim();

        renderField(meaningEl, meaning);
        renderField(synonymsEl, synonyms);
        renderField(antonymsEl, antonyms);
        renderField(exampleEl, exampleText);

        // âœ… ë¡œê·¸ì¸ ì‚¬ìš©ìì¼ ê²½ìš° ê²€ìƒ‰ ê¸°ë¡ ì €ì¥
        if (user && meaning.length > 0) {
          const now = new Date();
          const dateId = now.toISOString().slice(0, 10);

          const dateDocRef = doc(db, "users", user.email, "dates", dateId);
          await setDoc(dateDocRef, { createdAt: now.toISOString() }, { merge: true });

          const historyRef = doc(db, "users", user.email, "dates", dateId, "searchHistory", word);
          const prev = await getDoc(historyRef);
          const count = prev.exists() ? ((prev.data().count || 1) + 1) : 1;

          await setDoc(historyRef, {
            word,
            meaning,
            synonyms,
            antonyms,
            examples,
            searchedAt: now.toISOString(),
            count,
            study: false
          }, { merge: true });
        }

      } catch (err) {
        console.error(err);
        resultBox.style.display = "";
        resultBox.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
        [meaningEl, synonymsEl, antonymsEl, exampleEl].forEach(el => rowOf(el).style.display = "none");
      }
    });
  </script>
</body>

</html>