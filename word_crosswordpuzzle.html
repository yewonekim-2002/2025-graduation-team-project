<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì‹­ìë§í’€ì´ ê²Œì„</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gothic+A1:wght@400;600;700&display=swap');
        body {
            font-family: 'Gothic A1', sans-serif;
            background-color: #F7F9FC;
            color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }

        /* ------------------ ì‹­ìë§í’€ì´ ê·¸ë¦¬ë“œ ------------------ */
        .grid-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 0 auto 24px;
            max-width: 1200px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(15, minmax(0, 40px));
            grid-template-rows: repeat(15, minmax(0, 40px));
            gap: 1px;
            background: #D1D5DB;
            padding: 2px;
            border-radius: 6px;
        }
        .cell {
            width: 40px;
            height: 40px;
            background: #fff;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell.blocked { background: #E5E7EB; }
        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1.125rem;
            font-weight: bold;
            background: transparent;
            text-transform: uppercase;
        }
        .cell input:focus {
            outline: 3px solid #6366F1;
            z-index: 10;
        }
        .number {
            position: absolute;
            top: 1px;
            left: 3px;
            font-size: 0.6rem;
            color: #4B5563;
            pointer-events: none;
            line-height: 1;
        }

        .user-menu {
  position: relative;
  display: inline-block;
}
.user-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  transform: translateY(8px);
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  min-width: 160px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, .1);
  z-index: 100;
}
.user-dropdown a {
  display: block;
  padding: 8px 12px;
  font-size: 14px;
  color: #333;
  text-decoration: none;
}
.user-dropdown a:hover {
  background: #f0f0f0;
}
.user-menu:hover .user-dropdown {
  display: block;
}


        /* ------------------ ë‹¨ì–´ì¥ ì¹´ë“œ ìŠ¤íƒ€ì¼ ------------------ */
        .wordbook-card {
            background:#fff;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform .2s, box-shadow .2s;
            cursor: pointer;
        }
        .wordbook-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .wordbook-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }
        .wordbook-title h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .progress-bar-container {
            background-color: #E5E7EB;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #6366F1;
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .clues h3 {
            border-bottom: 2px solid #D1D5DB;
            padding-bottom: 4px;
            margin-top: 1rem;
            font-weight: 700;
            color: #1F2937;
        }
        .clues ul { padding-left: 1.5rem; }
        .clues li { margin: 0.5rem 0; font-size: 0.875rem; line-height: 1.4; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <!-- ğŸ§­ í—¤ë” -->
    <header class="bg-white shadow-md py-4">
        <nav class="container flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <a onclick="location.href='home.html'" class="text-gray-800 text-lg font-bold hover:text-blue-600">í™ˆ</a>
                <a onclick="location.href='word_main.html'" class="text-gray-800 text-lg font-bold hover:text-blue-600">ì–´íœ˜ í•™ìŠµ</a>
                <a onclick="location.href='word_tool_main.html'" class="text-blue-600 text-lg font-bold">í•™ìŠµ ë„êµ¬</a>
                <a onclick="location.href='word_dashboard.html'" class="text-gray-800 text-lg font-bold hover:text-blue-600">ì‚¬ìš©ì</a>
            </div>
            <div id="authContainer" class="flex items-center space-x-4"></div>
        </nav>
    </header>

    <main class="container">
        <!-- ğŸ“œ ë‹¨ì–´ì¥ ëª©ë¡ ì„¹ì…˜ -->
        <section id="crossword-list-section">
            <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì‹­ìë§í’€ì´ ê²Œì„</h1>
            <div id="wordbook-list-container" 
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
            </div>
        </section>

        <!-- ğŸ§© ì‹­ìë§í’€ì´ ì„¹ì…˜ -->
        <section id="crossword-study-section" class="hidden">
            <div class="flex justify-between items-center max-w-2xl mx-auto mb-6">
                <a href="word_crosswordpuzzle.html" onclick="showCrosswordList(); return false;" class="text-gray-500 hover:text-blue-600 transition">
                    <i class="fas fa-arrow-left mr-2"></i>ëª©ë¡ìœ¼ë¡œ
                </a>
                <button id="refreshBtn" class="px-4 py-2 rounded-full bg-white text-gray-800 text-sm font-semibold border border-gray-300 hover:bg-gray-100 transition">
                    <i class="fas fa-sync-alt mr-1"></i>ë‹¨ì–´ì¥ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
            <h1 id="crossword-study-title" class="text-3xl font-bold text-gray-900 mb-8 text-center"></h1>
            <div class="grid-container">
                <div id="grid" class="grid" aria-label="í¼ì¦ ê·¸ë¦¬ë“œ"></div>
                <div class="clues w-[300px] lg:w-[400px] max-h-[650px] overflow-auto p-4 bg-white rounded-lg shadow-md">
                    <h3 class="text-xl">ê°€ë¡œ ë¬¸ì œ</h3>
                    <ul id="acrossClues"></ul>
                    <h3 class="text-xl">ì„¸ë¡œ ë¬¸ì œ</h3>
                    <ul id="downClues"></ul>
                </div>
            </div>
            <div class="max-w-md mx-auto mt-6">
                <button class="w-full py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 transition" id="checkBtn">
                    ì •ë‹µ í™•ì¸ / ì±„ì 
                </button>
            </div>
        </section>
    </main>

    <!-- ğŸ§  ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXc7qF3lz2dbWOu1O3ftSNu8dye1RLk3E",
            authDomain: "auto-dictionary-29936.firebaseapp.com",
            projectId: "auto-dictionary-29936",
            storageBucket: "auto-dictionary-29936.appspot.com",
            messagingSenderId: "103494421267",
            appId: "1:103494421267:web:6762683fac5ac130e468e6",
            measurementId: "G-EKSJXHHRYS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const provider = new GoogleAuthProvider();

        const SIZE = 15;
        const MAX_WORDS = 30;
        const crosswordListSection = document.getElementById('crossword-list-section');
        const crosswordStudySection = document.getElementById('crossword-study-section');
        const wordbookListContainer = document.getElementById('wordbook-list-container');
        const crosswordStudyTitle = document.getElementById('crossword-study-title');
        const authContainer = document.getElementById('authContainer');
        const gridEl = document.getElementById('grid');
        const acrossCluesEl = document.getElementById('acrossClues');
        const downCluesEl = document.getElementById('downClues');
        const refreshBtn = document.getElementById('refreshBtn');
        const checkBtn = document.getElementById('checkBtn');

        let puzzleGrid = [];
        let placedWords = [];
        let authUser = null;
        let allWordbooksData = {};
        let currentWordbookId = null;

        function showSection(section) {
            [crosswordListSection, crosswordStudySection].forEach(s => s.classList.add('hidden'));
            section.classList.remove('hidden');
        }
        function showCrosswordList() { showSection(crosswordListSection); }

        function renderAuthUI(user) {
  authContainer.innerHTML = '';
  if (user) {
    const name = user.displayName || user.email || 'ì‚¬ìš©ì';
    const photo = user.photoURL || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';

    authContainer.innerHTML = `
      <div class="user-menu">
        <a href="#" class="flex items-center space-x-2">
          <span class="font-semibold">${name}</span>
          <img src="${photo}" class="w-7 h-7 rounded-full object-cover">
        </a>
        <div class="user-dropdown">
          <a href="#">${user.email || ''}</a>
          <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
      </div>
    `;

    document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      signOut(auth);
    });
  } else {
    authContainer.innerHTML = `
      <button id="loginBtn" class="px-4 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold">
        ë¡œê·¸ì¸
      </button>`;
    document.getElementById('loginBtn')?.addEventListener('click', () => signInWithPopup(auth, provider));
  }
}




        onAuthStateChanged(auth, async (user) => {
            authUser = user;
            renderAuthUI(user);
            if (user) {
                await populateWordbookList(user);
            } else {
                wordbookListContainer.innerHTML = `
                    <p class="text-center col-span-full text-lg text-gray-500 py-10">
                        ë‹¨ì–´ì¥ì„ í™•ì¸í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.
                    </p>
                `;
            }
        });

        // ğŸ“¦ ë‹¨ì–´ì¥ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function populateWordbookList(user) {
            wordbookListContainer.innerHTML = `
              <p class="text-center col-span-full text-lg text-gray-500 py-10">
                <i class="fas fa-sync fa-spin mr-2"></i> ë‹¨ì–´ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </p>`;

            allWordbooksData = {};
            const datesSnap = await getDocs(collection(db, "users", user.email, "dates"));
            const customSnap = await getDocs(collection(db, "users", user.email, "custom"));

            const allWordbooks = [
                ...(await getWordbooksFromSnap(datesSnap, "dates")),
                ...(await getWordbooksFromSnap(customSnap, "custom")),
            ].sort((a, b) => a.id.localeCompare(b.id));

            if (allWordbooks.length === 0) {
                wordbookListContainer.innerHTML = `<p class="text-center col-span-full text-gray-500 mt-4">ë‹¨ì–´ì¥ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            wordbookListContainer.innerHTML = '';
            allWordbooks.forEach(({ type, id, words }) => renderWordbookCard(type, id, words));
        }

        async function getWordbooksFromSnap(snapshot, type) {
            const result = [];
            for (const docSnap of snapshot.docs) {
                const wordbookId = docSnap.id;
                const searchSnap = await getDocs(collection(db, "users", authUser.email, type, wordbookId, "searchHistory"));
                const words = [];
                searchSnap.forEach(item => {
                    const d = item.data();
                    if (d.word && d.meaning?.length > 0) {
                        words.push({
                            word: String(d.word).toUpperCase(),
                            clue: Array.isArray(d.meaning) ? d.meaning[0] : d.meaning
                        });
                    }
                });
                if (words.length > 0) {
                    allWordbooksData[`${wordbookId}`] = { words, progress: 0, totalCells: 0, correctCells: 0 };
                    result.push({ type, id: wordbookId, words });
                }
            }
            return result;
        }

        function renderWordbookCard(type, wordbookId, words) {
  const card = document.createElement('div');
  card.className = 'wordbook-card';
  card.dataset.wordbookId = wordbookId;
  card.onclick = () => loadSelectedDate(wordbookId);
  
  card.innerHTML = `
    <div class="flex items-center mb-2">
      <i class="fa-solid ${type === "custom" ? "fa-user text-blue-600" : "fa-calendar-days text-blue-600"} mr-3"></i>
      <h3 class="text-lg font-bold text-gray-800">${wordbookId}</h3>
    </div>
    <p class="text-gray-600 text-sm">ì´ ${words.length}ê°œ ë‹¨ì–´</p>
  `;
  wordbookListContainer.appendChild(card);
}


        // ğŸ§© í¼ì¦ ìƒì„±
        async function loadSelectedDate(wordbookId) {
            if (!authUser) return alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.');
            const list = allWordbooksData[wordbookId].words;
            currentWordbookId = wordbookId;
            if (!list || list.length === 0) return alert('ì„ íƒí•œ ë‹¨ì–´ì¥ì— ìœ íš¨í•œ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');

            placedWords = [];
            puzzleGrid = Array.from({ length: SIZE }, () => Array.from({ length: SIZE }, () => null));

            let idx = 1;
            for (const item of list.slice(0, MAX_WORDS)) {
                if (item.word.length > SIZE) continue;
                const placed = placeWord(item, idx);
                if (!placed) forcePlaceWord(item, idx);
                idx++;
            }

            let totalCells = 0;
            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    if (puzzleGrid[r][c] && puzzleGrid[r][c].letter) totalCells++;
                }
            }
            allWordbooksData[wordbookId].totalCells = totalCells;

            crosswordStudyTitle.textContent = `${wordbookId} ì‹­ìë§í’€ì´`;
            createGrid();
            renderClues();
            showSection(crosswordStudySection);
        }

        // ğŸ§® ë‹¨ì–´ ë°°ì¹˜ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
        function canPlace(word, row, col, dir) {
            for (let k = 0; k < word.length; k++) {
                const r = row + (dir === 'down' ? k : 0);
                const c = col + (dir === 'across' ? k : 0);
                if (r < 0 || c < 0 || r >= SIZE || c >= SIZE) return false;
                if (puzzleGrid[r][c] && puzzleGrid[r][c].letter && puzzleGrid[r][c].letter !== word[k]) return false;
            }
            return true;
        }
        function applyPlacement(word, row, col, dir, num) {
            for (let k = 0; k < word.length; k++) {
                const r = row + (dir === 'down' ? k : 0);
                const c = col + (dir === 'across' ? k : 0);
                puzzleGrid[r][c] = puzzleGrid[r][c] || { letter: '', number: null };
                puzzleGrid[r][c].letter = word[k];
                if (k === 0 && puzzleGrid[r][c].number === null) puzzleGrid[r][c].number = num;
            }
        }
        function placeWord(item, num) {
            const word = item.word;
            if (placedWords.length === 0) {
                const row = Math.floor(SIZE / 2);
                const startCol = Math.floor((SIZE - word.length) / 2);
                if (canPlace(word, row, startCol, 'across')) {
                    applyPlacement(word, row, startCol, 'across', num);
                    placedWords.push({ ...item, row, col: startCol, dir: 'across', num });
                    return true;
                }
            }
            for (const existing of placedWords) {
                for (let i = 0; i < word.length; i++) {
                    for (let j = 0; j < existing.word.length; j++) {
                        if (word[i] === existing.word[j]) {
                            let row, col, dir;
                            if (existing.dir === 'across') {
                                row = existing.row - i;
                                col = existing.col + j;
                                dir = 'down';
                            } else {
                                row = existing.row + j;
                                col = existing.col - i;
                                dir = 'across';
                            }
                            if (canPlace(word, row, col, dir)) {
                                applyPlacement(word, row, col, dir, num);
                                placedWords.push({ ...item, row, col, dir, num });
                                return true;
                            }
                        }
                    }
                }
            }
            return false;
        }

        function forcePlaceWord(item, num) {
            const word = item.word;
            let attempts = 0;
            while (attempts < 100) {
                const dir = Math.random() < 0.5 ? 'across' : 'down';
                const row = Math.floor(Math.random() * SIZE);
                const col = Math.floor(Math.random() * SIZE);
                if (canPlace(word, row, col, dir)) {
                    applyPlacement(word, row, col, dir, num);
                    placedWords.push({ ...item, row, col, dir, num });
                    return true;
                }
                attempts++;
            }
            return false;
        }

        // ğŸ§© ê·¸ë¦¬ë“œ ìƒì„±
        function createGrid() {
            gridEl.innerHTML = '';
            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (!puzzleGrid[r][c]) {
                        cell.classList.add('blocked');
                    } else {
                        const inp = document.createElement('input');
                        inp.maxLength = 1;
                        inp.dataset.row = r;
                        inp.dataset.col = c;
                        inp.value = '';
                        inp.addEventListener('input', (e) => {
                            e.target.value = (e.target.value || '').toUpperCase().slice(0, 1);
                        });
                        cell.appendChild(inp);
                        if (puzzleGrid[r][c].number) {
                            const numDiv = document.createElement('div');
                            numDiv.className = 'number';
                            numDiv.textContent = puzzleGrid[r][c].number;
                            cell.appendChild(numDiv);
                        }
                    }
                    gridEl.appendChild(cell);
                }
            }
        }

        // ğŸ§¾ ë¬¸ì œ ë Œë”ë§
        function renderClues() {
            acrossCluesEl.innerHTML = '';
            downCluesEl.innerHTML = '';
            const sorted = placedWords.slice().sort((a, b) => (a.num || 0) - (b.num || 0));
            sorted.forEach(w => {
                const li = document.createElement('li');
                li.className = 'text-gray-700 list-disc ml-4';
                li.textContent = `${w.num}. ${w.clue}`;
                if (w.dir === 'down') downCluesEl.appendChild(li);
                else acrossCluesEl.appendChild(li);
            });
        }

        // ğŸ“ ì±„ì  ë¡œì§
        checkBtn.addEventListener('click', async () => {
            document.querySelectorAll('.cell input').forEach(inp => {
                inp.style.background = 'white';
                inp.classList.remove('bg-green-200', 'bg-red-200');
            });

            let correctCells = 0;
            let totalCells = 0;

            for (let r = 0; r < SIZE; r++) {
                for (let c = 0; c < SIZE; c++) {
                    const cellData = puzzleGrid[r][c];
                    if (!cellData || !cellData.letter) continue;
                    const input = document.querySelector(`input[data-row='${r}'][data-col='${c}']`);
                    if (!input) continue;

                    totalCells++;
                    const userAns = (input.value || '').toUpperCase();
                    const correctAns = cellData.letter.toUpperCase();

                    if (userAns === correctAns) {
                        input.classList.add('bg-green-200');
                        correctCells++;
                    } else {
                        input.classList.add('bg-red-200');
                        input.value = correctAns;
                    }
                }
            }

            const percentage = totalCells > 0 ? Math.round((correctCells / totalCells) * 100) : 0;
            alert(`ì±„ì  ê²°ê³¼: ${correctCells} / ${totalCells} ì¹¸ ì •ë‹µ (${percentage}%)`);

            await logToolResult(correctCells, totalCells);

            if (currentWordbookId) {
                updateWordbookProgress(
                    currentWordbookId,
                    correctCells,
                    allWordbooksData[currentWordbookId].totalCells || totalCells
                );
            }
        });

        // ğŸ§¾ Firestore ì±„ì  ê²°ê³¼ ì €ì¥
        async function logToolResult(correct, total) {
            const user = auth.currentUser;
            if (!user || !currentWordbookId) return;
            const toolRef = doc(db, "users", user.email, "tool", new Date().toISOString());
            await setDoc(toolRef, {
                type: "crossword",
                wordbookName: currentWordbookId,
                finishedAt: serverTimestamp(),
                correctCells: correct,
                totalCells: total
            }, { merge: true });
        }

        refreshBtn.addEventListener('click', async () => {
            if (!authUser) return alert('ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•˜ì„¸ìš”.');
            await populateWordbookList(authUser);
        });

        // â³ ì´ˆê¸° í™”ë©´ ì§„ì…
        window.onload = () => { showSection(crosswordListSection); };
    </script>
</body>
</html>
